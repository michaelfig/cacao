<!DOCTYPE html>
<html>
    <head><title>Cacao - MJPEG to MediaStream</title></head>
    <body>
        <h1>Cacao - MJPEG to MediaStream</h1>
        <p>First, run "cacao -p9000 /mjpeg=SOME-MJPEG-URL".  Then click
            <button onclick="go()">Go</button>.  You should see the image, canvas, and video all populate.
        </p>
        <table>
            <tr><th>Image</th> <td><img id="i" crossorigin /></td></tr>
            <tr><th>Video</th> <td><video id="v" autoplay playsinline /></td></tr>
            <tr><th>Canvas</th> <td><canvas id="c"></canvas></td></tr>
        </table>

    <script type="text/javascript">
    var ctx = c.getContext('2d');
    function drawImage() {
        ctx.drawImage(i, 0, 0);
    }
    function drawImageRAF() {
        drawImage();
        requestAnimationFrame(drawImageRAF);
    }
    i.onload = function () {
        i.onload = null;
        c.height = i.naturalHeight;
        c.width = i.naturalWidth;
        // setInterval(drawImage, 500);
        drawImageRAF();
        var stream = c.captureStream();
        whenStreamIsActive(stream, setSrc);
        function setSrc() {
            console.log('setting active video stream');
            v.srcObject = stream;
        }
    };

    function go() {
        i.src = "http://localhost:9000/mjpeg";
    }

    var streamActiveTimeout = {};
function whenStreamIsActive(stream, callback) {
    var id = stream.id;
    if (stream.active) {
        callback();
    }
    else if ('onactive' in stream) {
        stream.onactive = maybeCallback;
    }
    else if (!streamActiveTimeout[id]) {
        maybeCallback();
    }
    function maybeCallback() {
        delete streamActiveTimeout[id];
        if (stream.onactive === maybeCallback) {
            stream.onactive = null;
        }
        if (!stream.active) {
            // Safari needs a timeout to try again.
            // console.log('try again');
            streamActiveTimeout[id] = setTimeout(maybeCallback, 500);
            return;
        }
        callback();
    }
}
    </script>
    </body>

</html>